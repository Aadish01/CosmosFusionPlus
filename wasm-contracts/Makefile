# Osmosis-3 Factory Pattern Contracts Makefile

.PHONY: help build deploy test clean install check-docker all

# Default target
help:
	@echo "Osmosis-3 Factory Pattern Contracts"
	@echo "===================================="
	@echo ""
	@echo "Available commands:"
	@echo "  make install    - Install Node.js dependencies"
	@echo "  make build      - Build all contracts with Docker"
	@echo "  make deploy     - Deploy contracts to Osmosis testnet"
	@echo "  make test       - Test deployed contracts"
	@echo "  make clean      - Clean build artifacts"
	@echo "  make help       - Show this help message"
	@echo ""

# Install dependencies
install:
	@echo "ğŸ“¦ Installing dependencies..."
	@npm install

# Check if Docker is running
check-docker:
	@echo "ğŸ³ Checking Docker daemon..."
	@docker info > /dev/null 2>&1 || (echo "âŒ Docker is not running. Please start Docker Desktop and try again." && exit 1)
	@echo "âœ… Docker is running"

# Build all contracts with Docker
build: check-docker
	@echo "ğŸ”¨ Building HTLC contract with Docker..."
	docker run --rm --memory=4g --cpus=2 \
		-v "$(PWD)/escrow":/code \
		cosmwasm/rust-optimizer:0.17.0
	@echo "âœ… Escrow contract built!"

	@echo "ğŸ”¨ Building HTLC Factory contract with Docker..."
	docker run --rm --memory=4g --cpus=2 \
		-v "$(PWD)/escrowFactory":/code \
		cosmwasm/rust-optimizer:0.17.0
	@echo "âœ… Escrow Factory contract built!"

	@echo "ğŸ”¨ Building IBC contract with Docker..."
	docker run --rm --memory=4g --cpus=2 \
		-v "$(PWD)/ibc":/code \
		cosmwasm/rust-optimizer:0.17.0
	@echo "âœ… IBC contract built!"

	@echo "ğŸ‰ All contracts built successfully!"

# Deploy contracts
deploy: build
	@echo "ğŸš€ Deploying contracts..."
	npm run deploy

# Test contracts
test:
	@echo "ğŸ§ª Testing contracts..."
	npm run test

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf escrow/target/
	rm -rf escrowFactory/target/
	rm -rf ibc/target/
	rm -rf escrow/artifacts/
	rm -rf escrowFactory/artifacts/
	rm -rf ibc/artifacts/
	rm -rf node_modules/
	rm -f deployment.json
	@echo "âœ… Clean completed!"

# Full deployment pipeline
all: install build deploy test
	@echo "ğŸ‰ Full deployment pipeline completed!"


